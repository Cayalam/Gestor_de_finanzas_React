import { useEffect, useMemo, useState } from 'react'
import { Link } from 'react-router-dom'
import { useGroup } from '../context/GroupContext'
import * as txService from '../services/transactions'
import * as catService from '../services/categories'
import * as pocketsService from '../services/pockets'
import * as contributionsService from '../services/contributions'
import * as transfersService from '../services/transfers'

// FunciÃ³n para formatear fechas sin problemas de zona horaria
function formatLocalDate(dateString) {
  if (!dateString) return ''
  // Si la fecha viene en formato YYYY-MM-DD, parsearlo como fecha local
  if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
    const [year, month, day] = dateString.split('-').map(Number)
    const date = new Date(year, month - 1, day)
    return date.toLocaleDateString('es-ES')
  }
  return new Date(dateString).toLocaleDateString('es-ES')
}

function ToggleType({ value, onChange }) {
  return (
    <div className="grid grid-cols-2 gap-4">
      <button type="button" onClick={() => onChange('income')} className={`border rounded-xl p-6 text-center ${value==='income' ? 'border-green-500 bg-green-50' : ''}`}>
        <div className="text-2xl mb-2">â†—ï¸</div>
        <div className="font-medium">Ingreso</div>
      </button>
      <button type="button" onClick={() => onChange('expense')} className={`border rounded-xl p-6 text-center ${value==='expense' ? 'border-red-500 bg-red-50' : ''}`}>
        <div className="text-2xl mb-2">â†™ï¸</div>
        <div className="font-medium">Gasto</div>
      </button>
    </div>
  )
}

export default function Transactions() {
  const { activeGroup, getActiveGroupInfo, groups } = useGroup()
  const [open, setOpen] = useState(false)
  const [openContribution, setOpenContribution] = useState(false)
  const [openTransfer, setOpenTransfer] = useState(false)
  const [loading, setLoading] = useState(true)
  const [items, setItems] = useState([])
  const [form, setForm] = useState({
    id: null,
    type: 'expense',
    amount: '',
    date: new Date().toISOString().slice(0,10),
    category: '',
    pocket: '',
    description: ''
  })
  const [contributionForm, setContributionForm] = useState({
    grupo: '',
    monto: '',
    bolsillo_usuario: '',
    bolsillo_grupo: ''
  })
  const [transferForm, setTransferForm] = useState({
    bolsillo_origen: '',
    bolsillo_destino: '',
    monto: '',
    descripcion: ''
  })
  const [groupPockets, setGroupPockets] = useState([])
  const [error, setError] = useState('')
  const [confirmDelete, setConfirmDelete] = useState(null)

  useEffect(() => {
    (async () => {
      const data = await txService.list(activeGroup)
      setItems(data)
      setLoading(false)
    })()
  }, [activeGroup])

  const [categories, setCategories] = useState([])
  useEffect(() => {
    (async () => {
      const cats = await catService.list(activeGroup)
      setCategories(cats)
    })()
  }, [activeGroup])

  // Recargar categorÃ­as si vuelves a la pestaÃ±a o cambian en localStorage
  useEffect(() => {
    const reload = async () => setCategories(await catService.list(activeGroup))
    const onStorage = (e) => { if (e.key === 'demo_categories') reload() }
    const onFocus = () => reload()
    window.addEventListener('storage', onStorage)
    window.addEventListener('focus', onFocus)
    return () => { window.removeEventListener('storage', onStorage); window.removeEventListener('focus', onFocus) }
  }, [activeGroup])

  // Limpiar categorÃ­a si cambias el tipo y la selecciÃ³n ya no aplica
  useEffect(() => {
    if (!categories.find(c => c.type === form.type && c.name === form.category)) {
      setForm(prev => ({ ...prev, category: '' }))
    }
  }, [form.type, categories])

  const [pockets, setPockets] = useState([])
  useEffect(() => {
    (async () => setPockets(await pocketsService.list(activeGroup)))()
  }, [activeGroup])
  useEffect(() => {
    const reload = async () => setPockets(await pocketsService.list(activeGroup))
    const onStorage = (e) => { if (e.key === 'demo_pockets') reload() }
    const onFocus = () => reload()
    window.addEventListener('storage', onStorage)
    window.addEventListener('focus', onFocus)
    return () => { window.removeEventListener('storage', onStorage); window.removeEventListener('focus', onFocus) }
  }, [activeGroup])

  // Cargar bolsillos del grupo seleccionado para aportaciones
  useEffect(() => {
    if (contributionForm.grupo) {
      (async () => {
        const grupoPockets = await pocketsService.list(Number(contributionForm.grupo))
        setGroupPockets(grupoPockets)
      })()
    } else {
      setGroupPockets([])
    }
  }, [contributionForm.grupo])

  const onChange = (e) => setForm({ ...form, [e.target.name]: e.target.value })
  const categoriesByType = useMemo(() => categories.filter(c => c.type === form.type), [categories, form.type])
  const canSave = useMemo(() => Number(form.amount) > 0 && form.date && categoriesByType.length > 0 && !!form.category && pockets.length > 0 && !!form.pocket, [form, categoriesByType, pockets])

  const submit = async (e) => {
    e.preventDefault()
    setError('')
    if (categoriesByType.length === 0) {
      setError(`No hay categorÃ­as de ${form.type === 'income' ? 'ingreso' : 'gasto'}. Crea una en la secciÃ³n CategorÃ­as.`)
      return
    }
    if (!form.category) { setError('Selecciona una categorÃ­a'); return }
    if (pockets.length === 0) { setError('No hay bolsillos creados. Crea uno en la secciÃ³n Bolsillos.'); return }
    if (!form.pocket) { setError('Selecciona un bolsillo'); return }
    if (!Number(form.amount) || !form.date) { setError('Completa los campos obligatorios'); return }
    
    try {
      // Permitir enviar tanto id como nombre segÃºn servicio
      const selectedCat = categoriesByType.find(c => (c.id === form.category || c.name === form.category))
      const selectedPocket = pockets.find(p => (p.id === form.pocket || p.name === form.pocket))
      const payload = { 
        ...form, 
        amount: Number(form.amount),
        categoryId: selectedCat?.id, 
        pocketId: selectedPocket?.id,
      }
      
      if (form.id) {
        // Actualizar transacciÃ³n existente
        const updated = await txService.update(form.id, form.type, payload, activeGroup)
        setItems(prev => prev.map(x => x.id === updated.id ? updated : x))
      } else {
        // Crear nueva transacciÃ³n
        const created = await txService.create(payload, activeGroup)
        setItems(prev => [created, ...prev])
      }
      
      setOpen(false)
      setForm({ id: null, type: 'expense', amount: '', date: new Date().toISOString().slice(0,10), category: '', pocket: '', description: '' })
      // trigger dashboard reload in same tab
      localStorage.setItem('demo_transactions', JSON.stringify(JSON.parse(localStorage.getItem('demo_transactions')||'[]')))
    } catch (err) {
      // Capturar errores del backend (ej: saldo insuficiente)
      const detail = err?.response?.data?.detail
      if (detail) {
        setError(detail)
      } else if (err?.response?.data && typeof err.response.data === 'object') {
        // Si es un objeto con mÃºltiples errores
        const errors = Object.values(err.response.data).flat().join(', ')
        setError(errors || 'Error al guardar la transacciÃ³n')
      } else {
        setError(err?.message || 'Error al guardar la transacciÃ³n')
      }
    }
  }

  const startEdit = (tx) => {
    setForm({
      id: tx.id,
      type: tx.type,
      amount: String(tx.amount),
      date: tx.date,
      category: tx.categoryId || tx.category,
      pocket: tx.pocketId || tx.pocket,
      description: tx.description || ''
    })
    setOpen(true)
    setError('')
  }

  const remove = async () => {
    if (!confirmDelete) return
    try {
      await txService.remove(confirmDelete.id, confirmDelete.type)
      setItems(prev => prev.filter(x => x.id !== confirmDelete.id))
      localStorage.setItem('demo_transactions', JSON.stringify(JSON.parse(localStorage.getItem('demo_transactions')||'[]')))
      setConfirmDelete(null)
    } catch (err) {
      setError(err?.response?.data?.detail || err?.message || 'Error al eliminar la transacciÃ³n')
      setConfirmDelete(null)
    }
  }

  const submitContribution = async (e) => {
    e.preventDefault()
    setError('')
    
    if (!contributionForm.grupo || !contributionForm.monto || !contributionForm.bolsillo_usuario || !contributionForm.bolsillo_grupo) {
      setError('Completa todos los campos')
      return
    }

    if (Number(contributionForm.monto) <= 0) {
      setError('El monto debe ser mayor a 0')
      return
    }

    try {
      await contributionsService.contribute(
        Number(contributionForm.grupo),
        Number(contributionForm.monto),
        Number(contributionForm.bolsillo_usuario),
        Number(contributionForm.bolsillo_grupo)
      )
      
      setOpenContribution(false)
      setContributionForm({ grupo: '', monto: '', bolsillo_usuario: '', bolsillo_grupo: '' })
      setGroupPockets([])
      setError('')
      
      // Recargar transacciones
      const data = await txService.list(activeGroup)
      setItems(data)
      
      // Mostrar mensaje de Ã©xito
      alert('âœ… AportaciÃ³n realizada exitosamente')
    } catch (err) {
      const detail = err?.response?.data?.detail
      if (detail) {
        setError(detail)
      } else if (err?.response?.data && typeof err.response.data === 'object') {
        const errors = Object.values(err.response.data).flat().join(', ')
        setError(errors || 'Error al realizar la aportaciÃ³n')
      } else {
        setError(err?.message || 'Error al realizar la aportaciÃ³n')
      }
    }
  }

  const submitTransfer = async (e) => {
    e.preventDefault()
    setError('')
    
    if (!transferForm.bolsillo_origen || !transferForm.bolsillo_destino || !transferForm.monto) {
      setError('Completa todos los campos obligatorios')
      return
    }

    if (Number(transferForm.monto) <= 0) {
      setError('El monto debe ser mayor a 0')
      return
    }

    if (transferForm.bolsillo_origen === transferForm.bolsillo_destino) {
      setError('No puedes transferir al mismo bolsillo')
      return
    }

    try {
      await transfersService.transfer(
        Number(transferForm.bolsillo_origen),
        Number(transferForm.bolsillo_destino),
        Number(transferForm.monto),
        transferForm.descripcion
      )
      
      setOpenTransfer(false)
      setTransferForm({ bolsillo_origen: '', bolsillo_destino: '', monto: '', descripcion: '' })
      setError('')
      
      const data = await txService.list(activeGroup)
      setItems(data)
      const updatedPockets = await pocketsService.list(activeGroup)
      setPockets(updatedPockets)
      
      alert(' Transferencia realizada exitosamente')
    } catch (err) {
      const detail = err?.response?.data?.detail
      if (detail) {
        setError(detail)
      } else if (err?.response?.data && typeof err.response.data === 'object') {
        const errors = Object.values(err.response.data).flat().join(', ')
        setError(errors || 'Error al realizar la transferencia')
      } else {
        setError(err?.message || 'Error al realizar la transferencia')
      }
    }
  }
  return (
    <div className="px-2 md:px-0">
      <div className="flex items-center justify-between py-4">
        <div>
          <h2 className="text-2xl md:text-3xl font-bold">Transacciones</h2>
          <p className="text-sm text-gray-600">Gestiona tus ingresos y gastos</p>
        </div>
        <div className="flex gap-2">
          {!activeGroup && groups.length > 0 && (
            <button 
              onClick={() => setOpenContribution(true)} 
              className="btn bg-purple-600 hover:bg-purple-700 text-white flex items-center gap-2"
            >
              <span>ðŸ’°</span>
              <span className="hidden md:inline">Aportar al Grupo</span>
            </button>
          )}
                    {pockets.length > 1 && (
            <button 
              onClick={() => setOpenTransfer(true)} 
              className="btn bg-blue-600 hover:bg-blue-700 text-white flex items-center gap-2"
            >
              <span></span>
              <span className="hidden md:inline">Transferir</span>
            </button>
          )}
          <button onClick={() => setOpen(true)} className="btn btn-primary flex items-center gap-2">
            <span>ï¼‹</span>
            <span>Nueva TransacciÃ³n</span>
          </button>
        </div>
      </div>

      {open && (
        <div className="card p-5 mb-6">
          <form onSubmit={submit} className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div className="lg:col-span-2">
              <label className="block text-sm font-medium mb-2">Tipo de TransacciÃ³n</label>
              <ToggleType value={form.type} onChange={(t) => setForm({ ...form, type: t })} />
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Cantidad</label>
              <div className="flex items-center">
                <span className="px-3 py-2 border border-r-0 rounded-l-lg bg-white">â‚¬</span>
                <input name="amount" value={form.amount} onChange={onChange} type="number" step="0.01" placeholder="0.00" className="input rounded-r-lg" />
              </div>
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Fecha</label>
              <input name="date" value={form.date} onChange={onChange} type="date" className="input" />
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">CategorÃ­a</label>
              {categoriesByType.length ? (
                <select name="category" value={form.category} onChange={onChange} className="input">
                  <option value="">Seleccionar categorÃ­a</option>
                  {categoriesByType.map(c => (
                    <option key={c.id} value={c.id}>{c.name}</option>
                  ))}
                </select>
              ) : (
                <div className="text-sm text-gray-600">No hay categorÃ­as de {form.type === 'income' ? 'ingreso' : 'gasto'}. <Link to="/categories" className="text-blue-600 hover:underline">Crea una</Link>.</div>
              )}
            </div>
            <div>
              <label className="block text-sm font-medium mb-2">Bolsillo</label>
              {pockets.length ? (
                <select name="pocket" value={form.pocket} onChange={onChange} className="input">
                  <option value="">Seleccionar bolsillo</option>
                  {pockets.map(p => <option key={p.id} value={p.id}>{p.name || p.nombre}</option>)}
                </select>
              ) : (
                <div className="text-sm text-gray-600">No hay bolsillos creados. <Link to="/pockets" className="text-blue-600 hover:underline">Crea uno</Link>.</div>
              )}
            </div>
            <div className="lg:col-span-2">
              <label className="block text-sm font-medium mb-2">DescripciÃ³n</label>
              <input name="description" value={form.description} onChange={onChange} placeholder="DescripciÃ³n de la transacciÃ³n" className="input" />
            </div>
            {error && <div className="lg:col-span-2 text-red-600 text-sm">{error}</div>}
            <div className="lg:col-span-2 flex items-center justify-end gap-3">
              <button type="button" onClick={() => { setOpen(false); setForm({ id: null, type: 'expense', amount: '', date: new Date().toISOString().slice(0,10), category: '', pocket: '', description: '' }); setError(''); }} className="btn">Cancelar</button>
              <button disabled={!canSave} className="btn btn-primary" type="submit">{form.id ? 'Actualizar transacciÃ³n' : 'Guardar'}</button>
            </div>
          </form>
        </div>
      )}

      <div className="card">
        <div className="px-4 py-3 border-b flex items-center justify-between">
          <div className="text-sm font-medium">Historial</div>
          {loading && <div className="text-sm text-gray-500">Cargandoâ€¦</div>}
        </div>
        {items.length ? (
          <ul className="divide-y">
            {items.map(it => (
              <li key={it.id} className="px-4 py-3 flex items-center justify-between">
                <div>
                  <div className="font-medium">{it.description || (it.type==='income' ? 'Ingreso' : 'Gasto')}</div>
                  <div className="text-xs text-gray-500">{it.category || it.categoria?.nombre || 'Sin categorÃ­a'} â€¢ {it.pocket || it.bolsillo?.nombre || 'Sin bolsillo'} â€¢ {formatLocalDate(it.date || it.fecha)}</div>
                </div>
                <div className="flex items-center gap-4">
                  <div className={`${it.type==='income' ? 'text-green-600' : 'text-red-600'} font-semibold`}>{it.type==='income' ? '+' : '-'}â‚¬ {Number(it.amount).toFixed(2)}</div>
                  <button onClick={() => startEdit(it)} className="text-blue-600 hover:underline text-sm">Editar</button>
                  <button onClick={() => setConfirmDelete(it)} className="text-red-600 hover:underline text-sm">Eliminar</button>
                </div>
              </li>
            ))}
          </ul>
        ) : (
          <div className="px-4 py-8 text-sm text-gray-500">AÃºn no hay transacciones registradas.</div>
        )}
      </div>

      {/* Modal de confirmaciÃ³n de eliminaciÃ³n */}
      {confirmDelete && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
          <div className="card p-6 max-w-sm mx-4">
            <div className="text-lg font-semibold mb-2">Confirmar eliminaciÃ³n</div>
            <div className="text-sm text-gray-700 mb-4">
              Â¿Eliminar esta transacciÃ³n de {confirmDelete.type === 'income' ? 'ingreso' : 'gasto'} por â‚¬{Number(confirmDelete.amount).toFixed(2)}? Esta acciÃ³n no se puede deshacer.
            </div>
            <div className="flex justify-end gap-3">
              <button className="btn" onClick={() => setConfirmDelete(null)}>Cancelar</button>
              <button className="btn btn-danger" onClick={remove}>Eliminar</button>
            </div>
          </div>
        </div>
      )}

      {/* Modal de aportaciÃ³n a grupo */}
      {openContribution && (
        <div className="fixed inset-0 bg-black/40 flex items-center justify-center z-50">
          <div className="card p-6 max-w-md mx-4 w-full">
            <h3 className="text-xl font-bold mb-4">ðŸ’° Aportar Dinero al Grupo</h3>
            <p className="text-sm text-gray-600 mb-4">
              Selecciona un grupo y el bolsillo desde donde quieres enviar dinero. Esto crearÃ¡ un egreso en tu cuenta y un ingreso en el grupo.
            </p>
            
            <form onSubmit={submitContribution} className="space-y-4">
              <div>
                <label className="block text-sm font-medium mb-2">Grupo</label>
                <select
                  value={contributionForm.grupo}
                  onChange={(e) => setContributionForm({ ...contributionForm, grupo: e.target.value })}
                  className="input"
                  required
                >
                  <option value="">Selecciona un grupo</option>
                  {groups.map((g) => (
                    <option key={g.id || g.grupo_id} value={g.id || g.grupo_id}>
                      {g.nombre || g.name}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Bolsillo de Origen (Personal)</label>
                <select
                  value={contributionForm.bolsillo_usuario}
                  onChange={(e) => setContributionForm({ ...contributionForm, bolsillo_usuario: e.target.value })}
                  className="input"
                  required
                >
                  <option value="">Selecciona tu bolsillo</option>
                  {pockets.map((p) => (
                    <option key={p.id} value={p.id}>
                      {p.name} - Saldo: â‚¬{Number(p.balance || 0).toFixed(2)}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Monto</label>
                <div className="flex items-center">
                  <span className="px-3 py-2 border border-r-0 rounded-l-lg bg-white">â‚¬</span>
                  <input
                    type="number"
                    step="0.01"
                    min="0.01"
                    value={contributionForm.monto}
                    onChange={(e) => setContributionForm({ ...contributionForm, monto: e.target.value })}
                    placeholder="0.00"
                    className="input rounded-r-lg"
                    required
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium mb-2">Bolsillo de Destino (Grupo)</label>
                <select
                  value={contributionForm.bolsillo_grupo}
                  onChange={(e) => setContributionForm({ ...contributionForm, bolsillo_grupo: e.target.value })}
                  className="input"
                  required
                  disabled={!contributionForm.grupo}
                >
                  <option value="">
                    {!contributionForm.grupo ? 'Primero selecciona un grupo' : 'Selecciona el bolsillo del grupo'}
                  </option>
                  {groupPockets.map((p) => (
                    <option key={p.id} value={p.id}>
                      {p.name} - Saldo: â‚¬{Number(p.balance || 0).toFixed(2)}
                    </option>
                  ))}
                </select>
              </div>

              {error && (
                <div className="p-3 bg-red-50 border border-red-200 rounded-lg text-sm text-red-700">
                  {error}
                </div>
              )}

              <div className="flex justify-end gap-3 pt-2">
                <button 
                  type="button" 
                  onClick={() => {
                    setOpenContribution(false)
                    setContributionForm({ grupo: '', monto: '', bolsillo_usuario: '', bolsillo_grupo: '' })
                    setGroupPockets([])
                    setError('')
                  }} 
                  className="btn"
                >
                  Cancelar
                </button>
                <button type="submit" className="btn bg-purple-600 hover:bg-purple-700 text-white">
                  Aportar
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  )
}

